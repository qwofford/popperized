BootStrap: library
From: centos:latest

%post
    # Some spack packages complain if root
    export FORCE_UNSAFE_CONFIGURE=1
    export SPACK_ROOT=/usr/local
    mkdir -p /opt/bsp_prototype
    rpm --import https://www.centos.org/keys/RPM-GPG-KEY-CentOS-7
    yum -y install centos-release-scl 
    yum -y install wget gsl-devel libgfortran gmp-devel rh-python36 rh-python36-numpy zsh openssl-devel perf autoconf build-essential ca-certificates coreutils curl environment-modules git python unzip vim openmpi-devel
    yum -y group install "Development Tools"
    # IB stuff, based on https://community.mellanox.com/docs/DOC-2431
    yum -y install dapl dapl-utils ibacm infiniband-diags libibverbs libibverbs-devel libibverbs-utils libmlx4 librdmacm librdmacm-utils mstflint opensm-libs perftest qperf rdma

    git clone https://github.com/spack/spack.git /opt/spack
    export SPACK_ROOT=/opt/spack

    # Setup BASH function for module loading
    # Same as cat /usr/share/Modules/init/bash
    module() { eval `/usr/bin/modulecmd bash $*`; }
    export -f module
#    
#    MODULESHOME=/usr/share/Modules
#    export MODULESHOME
#    
#    if [ "${LOADEDMODULES:-}" = "" ]; then
#      LOADEDMODULES=
#      export LOADEDMODULES
#    fi
#    
#    if [ "${MODULEPATH:-}" = "" ]; then
#      MODULEPATH=`sed -n 's/[ 	#].*$//; /./H; $ { x; s/^\n//; s/\n/:/g; p; }' ${MODULESHOME}/init/.modulespath`
#      export MODULEPATH
#    fi
#    
#    if [ ${BASH_VERSINFO:-0} -ge 3 ] && [ -r ${MODULESHOME}/init/bash_completion ]; then
#     . ${MODULESHOME}/init/bash_completion
#    fi
    # End module config


    . /opt/spack/share/spack/setup-env.sh
    spack install openmpi@3.1.3
    spack install openspeedshop@2.4.0

    # Openmpi needed for test app compilation
    spack load openmpi@3.1.3
    

    ln -s /usr/lib64/openmpi/bin/* /usr/bin/
    wget -P /opt/bsp_prototype/ https://github.com/UNM-CARC/bsp_prototype/archive/a0a3e9b5f2c31f5cbccce6c1e1b618ea98152d62.zip
    unzip /opt/bsp_prototype/a0a3e9b5f2c31f5cbccce6c1e1b618ea98152d62.zip -d /opt/
    pushd /opt/bsp_prototype-a0a3e9b5f2c31f5cbccce6c1e1b618ea98152d62/sprng5
    /usr/bin/zsh ./installSprng
    popd
    pushd /opt/bsp_prototype-a0a3e9b5f2c31f5cbccce6c1e1b618ea98152d62/
    make
    popd
%environment
    export SPACK_ROOT=/opt/spack
    export LD_LIBRARY_PATH=/usr/lib/libibverbs:$LD_LIBRARY_PATH
    . /opt/spack/share/spack/setup-env.sh
    spack load openmpi@3.1.3
    spack load openspeedshop@2.4.0
%runscript
    /opt/rh/rh-python36/root/bin/python3.6 /opt/bsp_prototype-a0a3e9b5f2c31f5cbccce6c1e1b618ea98152d62/data_gen.py
    cat /tmp/results/*
%labels
    Author QuincyWofford,KeiraHaskins
